function alpha = bicubic_polynomial(h, k, p, px, py, pxy);
% Inputs p, px, py, pxy are assumed to be 2x2, with rows indexing x
% and columns indexing y, i.e.,
% p = [f(0,0) f(0,k);
%      f(h,0) f(h,k)]

%% Verify inputs

% h is the x-axis width, k is the y-axis width
if ~(isscalar(h) & isscalar(k)) | ~(h > 0 & k > 0)
    error(['Surface grid width and height must both be positive ' ...
           'scalars.']);
end

if ~(all(size(p) == [2 2]) & all(size(pxy) == [2 2]) ...
     & all(size(px) == [2 2]) & all(size(py) == [2 2]))
    error('Input function and  derivative matrices must all be 2x2.');
end

%% Calculate polynomial coefficients
% For alpha = [a00 a10 a20 a30 a01 a11 a21 a31 a02 a12 a22 a32 a03 a13 a23 a33]
% and x = [f(0,0) f(h,0) f(0,k) f(h,k) fx(0,0) fx(h,0) fx(0,k) fx(h,k)
%          fy(0,0) fy(h,0) fy(0,k) fy(h,k) fxy(0,0) fxy(h,0) fxy(0,k) fxy(h,k)]
% we have A*alpha = x, so we can solve by alpha = (A^-1)*x
x = [p(:); px(:); py(:); pxy(:)];
A = [1 0 0   0     0 0   0     0       0   0     0       0         0     0       0       0;           ...
     1 h h^2 h^3   0 0   0     0       0   0     0       0         0     0       0       0;           ...
     1 0 0   0     k 0   0     0       k^2 0     0       0         k^3   0       0       0;           ...
     1 h h^2 h^3   k h*k h^2*k h^3*k   k^2 h*k^2 h^2*k^2 h^3*k^2   k^3   h*k^3   h^2*k^3 h^3*k^3;     ...
     0 1 0   0     0 0   0     0       0   0     0       0         0     0       0       0;           ...
     0 1 2*h 3*h^2 0 0   0     0       0   0     0       0         0     0       0       0;           ...
     0 1 0   0     0 k   0     0       0   k^2   0       0         0     k^3     0       0;           ...
     0 1 2*h 3*h^2 0 k   2*h*k 3*h^2*k 0   k^2   2*h*k^2 3*h^2*k^2 0     k^3     2*h*k^3 3*h^2*k^3;   ...
     0 0 0   0     1 0   0     0       0   0     0       0         0     0       0       0;           ...
     0 0 0   0     1 h   h^2   h^3     0   0     0       0         0     0       0       0;           ...
     0 0 0   0     1 0   0     0       2*k 0     0       0         3*k^2 0       0       0;           ...
     0 0 0   0     1 h   h^2   h^3     2*k 2*h*k 2*h^2*k 2*h^3*k   3*k^2 3*h*k^2 3*h^2*k^2 3*h^3*k^3; ...
     0 0 0   0     0 1   0     0       0   0     0       0         0     0       0       0;           ...
     0 0 0   0     0 1   2*h   3*h^2   0   0     0       0         0     0       0       0;           ...
     0 0 0   0     0 1   0     0       0   2*k   0       0         0     3*k^2   0       0;           ...
     0 0 0   0     0 1   2*h   3*h^2   0   2*k   4*h*k   6*h^2*k   0     3*k^2   6*h*k^2 9*h^2*k^2];

alpha = inv(A) * x;
end
